{"version":3,"sources":["./src/app/features/home/camera/camera.page.ts","./src/app/features/home/camera/camera.page.html","./src/app/shared/camera/camera.service.ts","./src/app/shared/dialogs/dialogs.service.ts","./src/app/features/home/camera/camera.module.ts","./src/app/features/home/camera/camera-routing.module.ts"],"names":[],"mappings":"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","file":"4-es2015.fed822ac2a99a3b44a8a.js","sourcesContent":["import { Component, ElementRef, ViewChild } from '@angular/core';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { BehaviorSubject } from 'rxjs';\nimport { catchError, concatMap, distinctUntilChanged } from 'rxjs/operators';\nimport { CameraService } from '../../../shared/camera/camera.service';\nimport { DialogsService } from '../../../shared/dialogs/dialogs.service';\nimport { MomentRepository } from '../../../shared/moment/moment-repository.service';\nimport { concatTap, isNonNullable } from '../../../utils/rx-operators';\n\n@UntilDestroy()\n@Component({\n  selector: 'app-camera',\n  templateUrl: './camera.page.html',\n  styleUrls: ['./camera.page.scss'],\n})\nexport class CameraPage {\n  private readonly _videoElement$ = new BehaviorSubject<\n    HTMLVideoElement | undefined\n  >(undefined);\n\n  private readonly videoElement$ = this._videoElement$.pipe(\n    isNonNullable(),\n    distinctUntilChanged()\n  );\n\n  @ViewChild('video')\n  set videoElement(value: ElementRef<HTMLVideoElement>) {\n    this._videoElement$.next(value.nativeElement);\n  }\n\n  readonly capturedImageUrl$ = this.cameraService.capturedImageUrl$;\n\n  constructor(\n    private readonly dialogsService: DialogsService,\n    private readonly momentRepository: MomentRepository,\n    private readonly cameraService: CameraService\n  ) {\n    this.startPreview();\n  }\n\n  private startPreview() {\n    return this.videoElement$\n      .pipe(\n        concatMap(videoElement =>\n          this.cameraService.connectPreview$(videoElement)\n        ),\n        catchError(async (err: unknown) =>\n          this.dialogsService.presentError(err)\n        ),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n\n  capture() {\n    this.cameraService\n      .capture$()\n      .pipe(\n        concatTap(imageBlob => this.momentRepository.add$(imageBlob)),\n        catchError(async (err: unknown) =>\n          this.dialogsService.presentError(err)\n        ),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n}\n","<ion-button routerLink=\"..\" routerDirection=\"back\" class=\"dismiss\" fill=\"clear\">\n  <ion-icon slot=\"icon-only\" name=\"close-outline\" color=\"light\"></ion-icon>\n</ion-button>\n<ion-button (click)=\"capture()\" class=\"capture\" fill=\"clear\">\n  <ion-icon\n    slot=\"icon-only\"\n    name=\"radio-button-on-outline\"\n    color=\"light\"\n  ></ion-icon>\n</ion-button>\n<div\n  *ngrxLet=\"capturedImageUrl$ as capturedImageUrl\"\n  class=\"captured ion-margin\"\n>\n  <app-image ionImgViewer [src]=\"capturedImageUrl\"></app-image>\n</div>\n<video #video playsinline autoplay></video>\n","import { Injectable } from '@angular/core';\nimport { BehaviorSubject, defer, Observable } from 'rxjs';\nimport {\n  catchError,\n  concatMapTo,\n  distinctUntilChanged,\n  first,\n  map,\n  mapTo,\n  pairwise,\n  shareReplay,\n  switchMap,\n  tap,\n} from 'rxjs/operators';\nimport {\n  finalizeLast,\n  ignoreComplete,\n  isNonNullable,\n} from '../../utils/rx-operators';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class CameraService {\n  private readonly mediaStream$ = defer(() =>\n    navigator.mediaDevices.getUserMedia({\n      video: { facingMode: 'environment' },\n    })\n  ).pipe(\n    ignoreComplete(),\n    finalizeLast(mediaStream => {\n      mediaStream.getTracks().forEach(track => track.stop());\n    }),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly imageCapture$ = this.mediaStream$.pipe(\n    isNonNullable(),\n    map(mediaStream => mediaStream.getVideoTracks()[0]),\n    isNonNullable(),\n    map(track => new ImageCapture(track)),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly _capturedImageUrl$ = new BehaviorSubject<string | undefined>(\n    undefined\n  );\n\n  readonly capturedImageUrl$ = this._capturedImageUrl$.pipe(\n    isNonNullable(),\n    distinctUntilChanged(),\n    revokePreviousImageUrl()\n  );\n\n  connectPreview$(videoElement: HTMLVideoElement) {\n    return this.mediaStream$.pipe(\n      isNonNullable(),\n      tap(mediaStream => (videoElement.srcObject = mediaStream)),\n      mapTo(videoElement)\n    );\n  }\n\n  capture$() {\n    return this.imageCapture$.pipe(\n      first(),\n      switchMap(imageCapture => imageCapture.takePhoto()),\n      tap(imageBlob => {\n        this._capturedImageUrl$.next(URL.createObjectURL(imageBlob));\n      }),\n      catchError(async (err: unknown) => {\n        if (\n          err instanceof DOMException &&\n          (err.name === 'InvalidStateError' ||\n            err.name === 'UnknownError' ||\n            err.name === 'OperationError')\n        ) {\n          return undefined;\n        }\n        throw err;\n      }),\n      isNonNullable()\n    );\n  }\n}\n\nfunction revokePreviousImageUrl() {\n  return (source$: Observable<string>) =>\n    source$.pipe(\n      pairwise(),\n      tap(([previous]) => URL.revokeObjectURL(previous)),\n      concatMapTo(source$)\n    );\n}\n","import { Injectable } from '@angular/core';\nimport { AlertController } from '@ionic/angular';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class DialogsService {\n  constructor(private readonly alertController: AlertController) {}\n\n  async presentError(error: unknown) {\n    // eslint-disable-next-line no-console\n    console.error(error);\n    const alert = await this.alertController.create({\n      header: error instanceof Error ? error.name : 'Unknown Error',\n      message: error instanceof Error ? error.message : JSON.stringify(error),\n      buttons: [{ text: 'ok' }],\n    });\n    await alert.present();\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { NgxIonicImageViewerModule } from 'ngx-ionic-image-viewer';\nimport { SharedModule } from '../../../shared/shared.module';\nimport { CameraPageRoutingModule } from './camera-routing.module';\nimport { CameraPage } from './camera.page';\n\n@NgModule({\n  imports: [SharedModule, CameraPageRoutingModule, NgxIonicImageViewerModule],\n  declarations: [CameraPage],\n})\nexport class CameraPageModule {}\n","import { NgModule } from '@angular/core';\nimport { RouterModule, Routes } from '@angular/router';\nimport { CameraPage } from './camera.page';\n\nconst routes: Routes = [\n  {\n    path: '',\n    component: CameraPage,\n  },\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule],\n})\nexport class CameraPageRoutingModule {}\n"],"sourceRoot":"webpack:///"}