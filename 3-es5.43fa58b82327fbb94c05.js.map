{"version":3,"sources":["webpack:///src/app/features/home/camera/camera.page.html","webpack:///src/app/features/home/camera/camera.page.ts","webpack:///src/app/features/home/camera/camera.module.ts","webpack:///src/app/features/home/camera/camera-routing.module.ts"],"names":["CameraPage","alertController","momentRepository","_videoElement$","undefined","videoElement$","pipe","mediaStream$","navigator","mediaDevices","getUserMedia","video","facingMode","err","presentErrorDialog","bufferSize","refCount","imageCapture$","mediaStream","ImageCapture","getVideoTracks","_capturedImageUrl$","revokePreviousImageUrl$","previous","URL","revokeObjectURL","capturedImageUrl$","cameraPreview$","videoElement","srcObject","subscribe","value","next","nativeElement","imageCapture","takePhoto","imageBlob","createObjectURL","add$","console","error","create","header","Error","name","message","JSON","stringify","buttons","text","alert","present","getTracks","forEach","track","stop","capture","CameraPageModule","routes","path","component","CameraPageRoutingModule","forChild"],"mappings":"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","file":"3-es5.43fa58b82327fbb94c05.js","sourcesContent":["<ion-button routerLink=\"..\" routerDirection=\"back\" class=\"dismiss\" fill=\"clear\">\n  <ion-icon slot=\"icon-only\" name=\"close-outline\" color=\"light\"></ion-icon>\n</ion-button>\n<ion-button (click)=\"capture()\" class=\"capture\" fill=\"clear\">\n  <ion-icon\n    slot=\"icon-only\"\n    name=\"radio-button-on-outline\"\n    color=\"light\"\n  ></ion-icon>\n</ion-button>\n<div\n  *ngrxLet=\"capturedImageUrl$ as capturedImageUrl\"\n  class=\"captured ion-margin\"\n>\n  <app-image ionImgViewer [src]=\"capturedImageUrl\"></app-image>\n</div>\n<video #video playsinline autoplay></video>\n","import { Component, ElementRef, OnDestroy, ViewChild } from '@angular/core';\nimport { AlertController } from '@ionic/angular';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { BehaviorSubject, combineLatest, defer } from 'rxjs';\nimport {\n  catchError,\n  distinctUntilChanged,\n  first,\n  map,\n  pairwise,\n  shareReplay,\n  switchMap,\n  tap,\n} from 'rxjs/operators';\nimport { MomentRepository } from '../../../shared/moment/moment-repository.service';\nimport { concatTap, isNonNullable } from '../../../utils/rx-operators';\n\n@UntilDestroy()\n@Component({\n  selector: 'app-camera',\n  templateUrl: './camera.page.html',\n  styleUrls: ['./camera.page.scss'],\n})\nexport class CameraPage implements OnDestroy {\n  private readonly _videoElement$ = new BehaviorSubject<\n    HTMLVideoElement | undefined\n  >(undefined);\n\n  private readonly videoElement$ = this._videoElement$.pipe(\n    isNonNullable(),\n    distinctUntilChanged()\n  );\n\n  @ViewChild('video')\n  set videoElement(value: ElementRef<HTMLVideoElement>) {\n    this._videoElement$.next(value.nativeElement);\n  }\n\n  private readonly mediaStream$ = defer(() =>\n    navigator.mediaDevices.getUserMedia({\n      video: { facingMode: 'environment' },\n    })\n  ).pipe(\n    catchError(async (err: unknown) => {\n      await this.presentErrorDialog(err);\n      return undefined;\n    }),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly imageCapture$ = this.mediaStream$.pipe(\n    isNonNullable(),\n    map(mediaStream => new ImageCapture(mediaStream.getVideoTracks()[0])),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly _capturedImageUrl$ = new BehaviorSubject<string | undefined>(\n    undefined\n  );\n\n  private readonly revokePreviousImageUrl$ = this._capturedImageUrl$.pipe(\n    pairwise(),\n    tap(([previous]) => {\n      if (previous) URL.revokeObjectURL(previous);\n    })\n  );\n\n  readonly capturedImageUrl$ = this._capturedImageUrl$.pipe(\n    isNonNullable(),\n    distinctUntilChanged()\n  );\n\n  private readonly cameraPreview$ = combineLatest([\n    this.videoElement$,\n    this.mediaStream$.pipe(isNonNullable()),\n  ]).pipe(\n    tap(([videoElement, mediaStream]) => {\n      videoElement.srcObject = mediaStream;\n    })\n  );\n\n  constructor(\n    private readonly alertController: AlertController,\n    private readonly momentRepository: MomentRepository\n  ) {\n    this.revokePreviousImageUrl$.pipe(untilDestroyed(this)).subscribe();\n    this.cameraPreview$.pipe(untilDestroyed(this)).subscribe();\n  }\n\n  capture() {\n    this.imageCapture$\n      .pipe(\n        first(),\n        switchMap(imageCapture => imageCapture.takePhoto()),\n        tap(imageBlob => {\n          this._capturedImageUrl$.next(URL.createObjectURL(imageBlob));\n        }),\n        concatTap(imageBlob => this.momentRepository.add$(imageBlob)),\n        catchError(async (err: unknown) => {\n          await this.presentErrorDialog(err);\n          return undefined;\n        }),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n\n  async presentErrorDialog(err: unknown) {\n    // eslint-disable-next-line no-console\n    console.error(err);\n    const alert = await this.alertController.create({\n      header: err instanceof Error ? err.name : 'Unknown Error',\n      message: err instanceof Error ? err.message : JSON.stringify(err),\n      buttons: [{ text: 'ok' }],\n    });\n    await alert.present();\n  }\n\n  ngOnDestroy() {\n    this.mediaStream$\n      .pipe(\n        isNonNullable(),\n        first(),\n        tap(mediaStream =>\n          mediaStream.getTracks().forEach(track => track.stop())\n        )\n      )\n      .subscribe();\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { SharedModule } from '../../../shared/shared.module';\nimport { CameraPageRoutingModule } from './camera-routing.module';\nimport { CameraPage } from './camera.page';\n\n@NgModule({\n  imports: [SharedModule, CameraPageRoutingModule],\n  declarations: [CameraPage],\n})\nexport class CameraPageModule {}\n","import { NgModule } from '@angular/core';\nimport { RouterModule, Routes } from '@angular/router';\nimport { CameraPage } from './camera.page';\n\nconst routes: Routes = [\n  {\n    path: '',\n    component: CameraPage,\n  },\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule],\n})\nexport class CameraPageRoutingModule {}\n"]}