{"version":3,"sources":["webpack:///src/app/features/home/camera/camera.page.html","webpack:///src/app/features/home/camera/camera.page.ts","webpack:///src/app/shared/camera/camera.service.ts","webpack:///src/app/shared/dialogs/dialogs.service.ts","webpack:///src/app/features/home/camera/camera.module.ts","webpack:///src/app/features/home/camera/camera-routing.module.ts"],"names":["CameraPage","dialogsService","momentRepository","cameraService","videoDevices$","_videoElement$","undefined","videoElement$","pipe","capturedImageUrl$","startPreview","value","next","nativeElement","videoElement","connectPreview$","err","presentError","subscribe","capture$","imageBlob","add$","reverseCamera$","CameraService","navigator","mediaDevices","enumerateDevices","devices","filter","d","kind","bufferSize","refCount","_mediaStream$","t","v","console","log","mediaStream$","getEnvironmentCamera","mediaStream","stopPreviousMediaStream","stopMediaStream","imageCapture$","getVideoTracks","track","ImageCapture","_capturedImageUrl$","revokePreviousImageUrl","imageCapture","takePhoto","URL","createObjectURL","DOMException","name","videoTrack","getConstraints","facingMode","getUserCamera","e","error","source$","previous","revokeObjectURL","forEach","stop","getUserMedia","video","DialogsService","alertController","create","header","Error","message","JSON","stringify","buttons","text","alert","present","CameraPageModule","routes","path","component","CameraPageRoutingModule","forChild"],"mappings":"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","file":"4-es5.da5fe469d0e301e2aabb.js","sourcesContent":["<ion-button routerLink=\"..\" routerDirection=\"back\" class=\"dismiss\" fill=\"clear\">\n  <ion-icon slot=\"icon-only\" name=\"close-outline\" color=\"light\"></ion-icon>\n</ion-button>\n<ng-container *ngIf=\"(videoDevices$ | ngrxPush)?.length !== 0; else noCamera\">\n  <ion-button (click)=\"capture()\" class=\"capture\" fill=\"clear\">\n    <ion-icon\n      slot=\"icon-only\"\n      name=\"radio-button-on-outline\"\n      color=\"light\"\n    ></ion-icon>\n  </ion-button>\n  <ion-button\n    *ngIf=\"true\"\n    (click)=\"reverseCamera()\"\n    class=\"capture\"\n    class=\"reverse-camera\"\n    fill=\"clear\"\n  >\n    <ion-icon\n      slot=\"icon-only\"\n      name=\"camera-reverse-outline\"\n      color=\"light\"\n    ></ion-icon>\n  </ion-button>\n  <div\n    *ngrxLet=\"capturedImageUrl$ as capturedImageUrl\"\n    class=\"captured ion-margin\"\n  >\n    <app-image [src]=\"capturedImageUrl\"></app-image>\n  </div>\n  <video #video playsinline autoplay></video>\n</ng-container>\n<ng-template #noCamera>\n  <div class=\"no-camera\">\n    <div *transloco=\"let t\" class=\"no-camera-illustration\">\n      <ion-img src=\"./assets/icons/undraw-void.svg\"></ion-img>\n      <h3>{{ t('noCameraFound') }}</h3>\n      <p>{{ t('message.noCameraFound') }}</p>\n    </div>\n  </div>\n</ng-template>\n","import { Component, ElementRef, ViewChild } from '@angular/core';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { BehaviorSubject } from 'rxjs';\nimport { catchError, concatMap, distinctUntilChanged } from 'rxjs/operators';\nimport { CameraService } from '../../../shared/camera/camera.service';\nimport { DialogsService } from '../../../shared/dialogs/dialogs.service';\nimport { MomentRepository } from '../../../shared/moment/moment-repository.service';\nimport { concatTap, isNonNullable } from '../../../utils/rx-operators';\n\n@UntilDestroy()\n@Component({\n  selector: 'app-camera',\n  templateUrl: './camera.page.html',\n  styleUrls: ['./camera.page.scss'],\n})\nexport class CameraPage {\n  readonly videoDevices$ = this.cameraService.videoDevices$;\n\n  private readonly _videoElement$ = new BehaviorSubject<\n    HTMLVideoElement | undefined\n  >(undefined);\n\n  private readonly videoElement$ = this._videoElement$.pipe(\n    isNonNullable(),\n    distinctUntilChanged()\n  );\n\n  @ViewChild('video')\n  set videoElement(value: ElementRef<HTMLVideoElement> | undefined) {\n    if (value) this._videoElement$.next(value.nativeElement);\n  }\n\n  readonly capturedImageUrl$ = this.cameraService.capturedImageUrl$;\n\n  constructor(\n    private readonly dialogsService: DialogsService,\n    private readonly momentRepository: MomentRepository,\n    private readonly cameraService: CameraService\n  ) {\n    this.startPreview();\n  }\n\n  private startPreview() {\n    return this.videoElement$\n      .pipe(\n        concatMap(videoElement =>\n          this.cameraService.connectPreview$(videoElement)\n        ),\n        catchError(async (err: unknown) =>\n          this.dialogsService.presentError(err)\n        ),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n\n  capture() {\n    this.cameraService\n      .capture$()\n      .pipe(\n        concatTap(imageBlob => this.momentRepository.add$(imageBlob)),\n        catchError(async (err: unknown) =>\n          this.dialogsService.presentError(err)\n        ),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n\n  reverseCamera() {\n    return this.videoElement$\n      .pipe(\n        concatMap(videoElement =>\n          this.cameraService.reverseCamera$(videoElement)\n        ),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n}\n","/* eslint-disable no-console */\nimport { Injectable } from '@angular/core';\nimport { BehaviorSubject, defer, iif, Observable, ReplaySubject } from 'rxjs';\nimport {\n  catchError,\n  concatMapTo,\n  distinctUntilChanged,\n  first,\n  map,\n  mapTo,\n  pairwise,\n  shareReplay,\n  startWith,\n  switchMap,\n  tap,\n} from 'rxjs/operators';\nimport {\n  concatTap,\n  finalizeLast,\n  isNonNullable,\n} from '../../utils/rx-operators';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class CameraService {\n  readonly videoDevices$ = defer(() =>\n    navigator.mediaDevices.enumerateDevices()\n  ).pipe(\n    map(devices => devices.filter(d => d.kind === 'videoinput')),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly _mediaStream$ = new ReplaySubject<MediaStream>(1);\n\n  private readonly t = this._mediaStream$\n    .pipe(tap(v => console.log('next', v)))\n    .subscribe();\n\n  private readonly mediaStream$ = defer(() => getEnvironmentCamera()).pipe(\n    tap(v => console.log('init', v)),\n    tap(mediaStream => this._mediaStream$.next(mediaStream)),\n    concatMapTo(this._mediaStream$),\n    shareReplay({ bufferSize: 1, refCount: true }),\n    tap(v => console.log('here', v)),\n    isNonNullable(),\n    stopPreviousMediaStream(),\n    finalizeLast(mediaStream => {\n      if (mediaStream) stopMediaStream(mediaStream);\n    }),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly imageCapture$ = this.mediaStream$.pipe(\n    map(mediaStream => mediaStream.getVideoTracks()[0]),\n    isNonNullable(),\n    map(track => new ImageCapture(track)),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly _capturedImageUrl$ = new BehaviorSubject<string | undefined>(\n    undefined\n  );\n\n  readonly capturedImageUrl$ = this._capturedImageUrl$.pipe(\n    isNonNullable(),\n    distinctUntilChanged(),\n    revokePreviousImageUrl()\n  );\n\n  connectPreview$(videoElement: HTMLVideoElement) {\n    return this.mediaStream$.pipe(\n      tap(v => console.log('preview', v)),\n      // tap(mediaStream => (videoElement.srcObject = mediaStream)),\n      mapTo(videoElement)\n    );\n  }\n\n  capture$() {\n    return this.imageCapture$.pipe(\n      first(),\n      switchMap(imageCapture => imageCapture.takePhoto()),\n      tap(imageBlob => {\n        this._capturedImageUrl$.next(URL.createObjectURL(imageBlob));\n      }),\n      catchError(async (err: unknown) => {\n        if (\n          err instanceof DOMException &&\n          (err.name === 'InvalidStateError' ||\n            err.name === 'UnknownError' ||\n            err.name === 'OperationError')\n        ) {\n          return undefined;\n        }\n        throw err;\n      }),\n      isNonNullable()\n    );\n  }\n\n  reverseCamera$(videoElement: HTMLVideoElement) {\n    return this.mediaStream$.pipe(\n      first(),\n      map(mediaStream => mediaStream.getVideoTracks()[0]),\n      isNonNullable(),\n      map(videoTrack => videoTrack.getConstraints().facingMode),\n      isNonNullable(),\n      // tap(() => (videoElement.srcObject = null)),\n      concatTap(facingMode =>\n        iif(\n          () => facingMode === 'environment',\n          defer(async () => {\n            console.log('b', facingMode);\n            this._mediaStream$.next(await getUserCamera());\n            console.log('a', facingMode);\n          }),\n          defer(async () => {\n            console.log('b', facingMode);\n            this._mediaStream$.next(await getEnvironmentCamera());\n            console.log('a', facingMode);\n          })\n        )\n      ),\n      tap(() => console.log('afterPushNext', videoElement)),\n      catchError(async (err: unknown) => {\n        const e = err as any;\n        console.error(e.name, e);\n      })\n    );\n  }\n}\n\nfunction revokePreviousImageUrl() {\n  return (source$: Observable<string>) =>\n    source$.pipe(\n      startWith(undefined),\n      pairwise(),\n      tap(([previous]) => {\n        if (previous) URL.revokeObjectURL(previous);\n      }),\n      concatMapTo(source$)\n    );\n}\n\nfunction stopPreviousMediaStream() {\n  return (source$: Observable<MediaStream>) =>\n    source$.pipe(\n      startWith(undefined),\n      pairwise(),\n      tap(([previous]) => {\n        if (previous) stopMediaStream(previous);\n      }),\n      concatMapTo(source$)\n    );\n}\n\nfunction stopMediaStream(mediaStream: MediaStream) {\n  mediaStream.getVideoTracks().forEach(t => t.stop());\n  return mediaStream;\n}\n\nasync function getEnvironmentCamera() {\n  return navigator.mediaDevices.getUserMedia({\n    video: { facingMode: 'environment' },\n  });\n}\n\nasync function getUserCamera() {\n  return navigator.mediaDevices.getUserMedia({\n    video: { facingMode: 'user' },\n  });\n}\n","import { Injectable } from '@angular/core';\nimport { AlertController } from '@ionic/angular';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class DialogsService {\n  constructor(private readonly alertController: AlertController) {}\n\n  async presentError(error: unknown) {\n    // eslint-disable-next-line no-console\n    console.error(error);\n    const alert = await this.alertController.create({\n      header: error instanceof Error ? error.name : 'Unknown Error',\n      message: error instanceof Error ? error.message : JSON.stringify(error),\n      buttons: [{ text: 'ok' }],\n    });\n    await alert.present();\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { NgxIonicImageViewerModule } from 'ngx-ionic-image-viewer';\nimport { SharedModule } from '../../../shared/shared.module';\nimport { CameraPageRoutingModule } from './camera-routing.module';\nimport { CameraPage } from './camera.page';\n\n@NgModule({\n  imports: [SharedModule, CameraPageRoutingModule, NgxIonicImageViewerModule],\n  declarations: [CameraPage],\n})\nexport class CameraPageModule {}\n","import { NgModule } from '@angular/core';\nimport { RouterModule, Routes } from '@angular/router';\nimport { CameraPage } from './camera.page';\n\nconst routes: Routes = [\n  {\n    path: '',\n    component: CameraPage,\n  },\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule],\n})\nexport class CameraPageRoutingModule {}\n"]}