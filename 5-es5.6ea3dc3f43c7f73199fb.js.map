{"version":3,"sources":["webpack:///src/app/features/home/camera/camera.page.html","webpack:///src/app/features/home/camera/camera.page.ts","webpack:///src/app/features/home/camera/camera.module.ts","webpack:///src/app/features/home/camera/camera-routing.module.ts"],"names":["CameraPage","alertController","momentRepository","_videoElement$","undefined","videoElement$","pipe","mediaStream$","navigator","mediaDevices","getUserMedia","video","facingMode","err","presentErrorDialog","bufferSize","refCount","imageCapture$","mediaStream","getVideoTracks","track","ImageCapture","_capturedImageUrl$","revokePreviousImageUrl$","previous","URL","revokeObjectURL","capturedImageUrl$","cameraPreview$","videoElement","srcObject","subscribe","value","next","nativeElement","imageCapture","takePhoto","imageBlob","createObjectURL","add$","DOMException","name","console","error","create","header","Error","message","JSON","stringify","buttons","text","alert","present","getTracks","forEach","stop","capture","CameraPageModule","routes","path","component","CameraPageRoutingModule","forChild"],"mappings":"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","file":"5-es5.6ea3dc3f43c7f73199fb.js","sourcesContent":["<ion-button routerLink=\"..\" routerDirection=\"back\" class=\"dismiss\" fill=\"clear\">\n  <ion-icon slot=\"icon-only\" name=\"close-outline\" color=\"light\"></ion-icon>\n</ion-button>\n<ion-button (click)=\"capture()\" class=\"capture\" fill=\"clear\">\n  <ion-icon\n    slot=\"icon-only\"\n    name=\"radio-button-on-outline\"\n    color=\"light\"\n  ></ion-icon>\n</ion-button>\n<div\n  *ngrxLet=\"capturedImageUrl$ as capturedImageUrl\"\n  class=\"captured ion-margin\"\n>\n  <app-image ionImgViewer [src]=\"capturedImageUrl\"></app-image>\n</div>\n<video #video playsinline autoplay></video>\n","import { Component, ElementRef, OnDestroy, ViewChild } from '@angular/core';\nimport { AlertController } from '@ionic/angular';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { BehaviorSubject, combineLatest, defer } from 'rxjs';\nimport {\n  catchError,\n  distinctUntilChanged,\n  first,\n  map,\n  pairwise,\n  shareReplay,\n  switchMap,\n  tap,\n} from 'rxjs/operators';\nimport { MomentRepository } from '../../../shared/moment/moment-repository.service';\nimport { concatTap, isNonNullable } from '../../../utils/rx-operators';\n\n@UntilDestroy()\n@Component({\n  selector: 'app-camera',\n  templateUrl: './camera.page.html',\n  styleUrls: ['./camera.page.scss'],\n})\nexport class CameraPage implements OnDestroy {\n  private readonly _videoElement$ = new BehaviorSubject<\n    HTMLVideoElement | undefined\n  >(undefined);\n\n  private readonly videoElement$ = this._videoElement$.pipe(\n    isNonNullable(),\n    distinctUntilChanged()\n  );\n\n  @ViewChild('video')\n  set videoElement(value: ElementRef<HTMLVideoElement>) {\n    this._videoElement$.next(value.nativeElement);\n  }\n\n  private readonly mediaStream$ = defer(() =>\n    navigator.mediaDevices.getUserMedia({\n      video: { facingMode: 'environment' },\n    })\n  ).pipe(\n    catchError(async (err: unknown) => {\n      await this.presentErrorDialog(err);\n      return undefined;\n    }),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly imageCapture$ = this.mediaStream$.pipe(\n    isNonNullable(),\n    map(mediaStream => mediaStream.getVideoTracks()[0]),\n    isNonNullable(),\n    map(track => new ImageCapture(track)),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly _capturedImageUrl$ = new BehaviorSubject<string | undefined>(\n    undefined\n  );\n\n  private readonly revokePreviousImageUrl$ = this._capturedImageUrl$.pipe(\n    pairwise(),\n    tap(([previous]) => {\n      if (previous) URL.revokeObjectURL(previous);\n    })\n  );\n\n  readonly capturedImageUrl$ = this._capturedImageUrl$.pipe(\n    isNonNullable(),\n    distinctUntilChanged()\n  );\n\n  private readonly cameraPreview$ = combineLatest([\n    this.videoElement$,\n    this.mediaStream$.pipe(isNonNullable()),\n  ]).pipe(\n    tap(([videoElement, mediaStream]) => {\n      videoElement.srcObject = mediaStream;\n    })\n  );\n\n  constructor(\n    private readonly alertController: AlertController,\n    private readonly momentRepository: MomentRepository\n  ) {\n    this.revokePreviousImageUrl$.pipe(untilDestroyed(this)).subscribe();\n    this.cameraPreview$.pipe(untilDestroyed(this)).subscribe();\n  }\n\n  capture() {\n    this.imageCapture$\n      .pipe(\n        first(),\n        switchMap(imageCapture => imageCapture.takePhoto()),\n        tap(imageBlob => {\n          this._capturedImageUrl$.next(URL.createObjectURL(imageBlob));\n        }),\n        concatTap(imageBlob => this.momentRepository.add$(imageBlob)),\n        catchError(async (err: unknown) => {\n          if (\n            err instanceof DOMException &&\n            (err.name === 'InvalidStateError' ||\n              err.name === 'UnknownError' ||\n              err.name === 'OperationError')\n          ) {\n            return undefined;\n          }\n          return this.presentErrorDialog(err);\n        }),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n\n  async presentErrorDialog(err: unknown) {\n    // eslint-disable-next-line no-console\n    console.error(err);\n    const alert = await this.alertController.create({\n      header: err instanceof Error ? err.name : 'Unknown Error',\n      message: err instanceof Error ? err.message : JSON.stringify(err),\n      buttons: [{ text: 'ok' }],\n    });\n    await alert.present();\n  }\n\n  ngOnDestroy() {\n    this.mediaStream$\n      .pipe(\n        isNonNullable(),\n        first(),\n        tap(mediaStream =>\n          mediaStream.getTracks().forEach(track => track.stop())\n        )\n      )\n      .subscribe();\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { NgxIonicImageViewerModule } from 'ngx-ionic-image-viewer';\nimport { SharedModule } from '../../../shared/shared.module';\nimport { CameraPageRoutingModule } from './camera-routing.module';\nimport { CameraPage } from './camera.page';\n\n@NgModule({\n  imports: [SharedModule, CameraPageRoutingModule, NgxIonicImageViewerModule],\n  declarations: [CameraPage],\n})\nexport class CameraPageModule {}\n","import { NgModule } from '@angular/core';\nimport { RouterModule, Routes } from '@angular/router';\nimport { CameraPage } from './camera.page';\n\nconst routes: Routes = [\n  {\n    path: '',\n    component: CameraPage,\n  },\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule],\n})\nexport class CameraPageRoutingModule {}\n"]}