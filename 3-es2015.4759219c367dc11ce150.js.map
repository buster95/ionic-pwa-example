{"version":3,"sources":["./src/app/features/home/camera/camera.page.ts","./src/app/features/home/camera/camera.page.html","./src/app/features/home/camera/camera.module.ts","./src/app/features/home/camera/camera-routing.module.ts"],"names":[],"mappings":"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","file":"3-es2015.4759219c367dc11ce150.js","sourcesContent":["import { Component, ElementRef, OnDestroy, ViewChild } from '@angular/core';\nimport { AlertController } from '@ionic/angular';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { BehaviorSubject, combineLatest, defer } from 'rxjs';\nimport {\n  catchError,\n  distinctUntilChanged,\n  map,\n  pairwise,\n  shareReplay,\n  switchMap,\n  tap,\n} from 'rxjs/operators';\nimport { MomentRepository } from '../../../shared/moment/moment-repository.service';\nimport { concatTap, isNonNullable } from '../../../utils/rx-operators';\n\n@UntilDestroy()\n@Component({\n  selector: 'app-camera',\n  templateUrl: './camera.page.html',\n  styleUrls: ['./camera.page.scss'],\n})\nexport class CameraPage implements OnDestroy {\n  private readonly _videoElement$ = new BehaviorSubject<\n    HTMLVideoElement | undefined\n  >(undefined);\n\n  private readonly videoElement$ = this._videoElement$.pipe(\n    isNonNullable(),\n    distinctUntilChanged()\n  );\n\n  @ViewChild('video')\n  set videoElement(value: ElementRef<HTMLVideoElement>) {\n    this._videoElement$.next(value.nativeElement);\n  }\n\n  private readonly mediaStream$ = defer(() =>\n    navigator.mediaDevices.getUserMedia({\n      video: { facingMode: 'environment' },\n    })\n  ).pipe(\n    catchError(async (err: unknown) => {\n      await this.presentErrorDialog(err);\n      return undefined;\n    }),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly imageCapture$ = this.mediaStream$.pipe(\n    isNonNullable(),\n    map(mediaStream => new ImageCapture(mediaStream.getVideoTracks()[0])),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly _capturedImageUrl$ = new BehaviorSubject<string | undefined>(\n    undefined\n  );\n\n  private readonly revokePreviousImageUrl$ = this._capturedImageUrl$.pipe(\n    pairwise(),\n    tap(([previous]) => {\n      if (previous) URL.revokeObjectURL(previous);\n    })\n  );\n\n  readonly capturedImageUrl$ = this._capturedImageUrl$.pipe(\n    isNonNullable(),\n    distinctUntilChanged()\n  );\n\n  private readonly cameraPreview$ = combineLatest([\n    this.videoElement$,\n    this.mediaStream$.pipe(isNonNullable()),\n  ]).pipe(\n    tap(([videoElement, mediaStream]) => {\n      videoElement.srcObject = mediaStream;\n    })\n  );\n\n  constructor(\n    private readonly alertController: AlertController,\n    private readonly momentRepository: MomentRepository\n  ) {\n    this.revokePreviousImageUrl$.pipe(untilDestroyed(this)).subscribe();\n    this.cameraPreview$.pipe(untilDestroyed(this)).subscribe();\n  }\n\n  capture() {\n    this.imageCapture$\n      .pipe(\n        switchMap(imageCapture => imageCapture.takePhoto()),\n        tap(imageBlob => {\n          this._capturedImageUrl$.next(URL.createObjectURL(imageBlob));\n        }),\n        concatTap(imageBlob => this.momentRepository.add$(imageBlob)),\n        catchError(async (err: unknown) => {\n          await this.presentErrorDialog(err);\n          return undefined;\n        }),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n\n  async presentErrorDialog(err: unknown) {\n    // eslint-disable-next-line no-console\n    console.error(err);\n    const alert = await this.alertController.create({\n      header: err instanceof Error ? err.name : 'Unknown Error',\n      message: err instanceof Error ? err.message : JSON.stringify(err),\n      buttons: [{ text: 'ok' }],\n    });\n    await alert.present();\n  }\n\n  ngOnDestroy() {\n    this.mediaStream$\n      .pipe(\n        isNonNullable(),\n        tap(mediaStream =>\n          mediaStream.getTracks().forEach(track => track.stop())\n        )\n      )\n      .subscribe();\n  }\n}\n","<ion-button routerLink=\"..\" routerDirection=\"back\" class=\"dismiss\" fill=\"clear\">\n  <ion-icon slot=\"icon-only\" name=\"close-outline\" color=\"light\"></ion-icon>\n</ion-button>\n<ion-button (click)=\"capture()\" class=\"capture\" fill=\"clear\">\n  <ion-icon\n    slot=\"icon-only\"\n    name=\"radio-button-on-outline\"\n    color=\"light\"\n  ></ion-icon>\n</ion-button>\n<div\n  *ngrxLet=\"capturedImageUrl$ as capturedImageUrl\"\n  class=\"captured ion-margin\"\n>\n  <app-image ionImgViewer [src]=\"capturedImageUrl\"></app-image>\n</div>\n<video #video playsinline autoplay></video>\n","import { NgModule } from '@angular/core';\nimport { SharedModule } from '../../../shared/shared.module';\nimport { CameraPageRoutingModule } from './camera-routing.module';\nimport { CameraPage } from './camera.page';\n\n@NgModule({\n  imports: [SharedModule, CameraPageRoutingModule],\n  declarations: [CameraPage],\n})\nexport class CameraPageModule {}\n","import { NgModule } from '@angular/core';\nimport { RouterModule, Routes } from '@angular/router';\nimport { CameraPage } from './camera.page';\n\nconst routes: Routes = [\n  {\n    path: '',\n    component: CameraPage,\n  },\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule],\n})\nexport class CameraPageRoutingModule {}\n"],"sourceRoot":"webpack:///"}