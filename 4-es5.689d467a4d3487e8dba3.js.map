{"version":3,"sources":["webpack:///src/app/features/home/camera/camera.page.html","webpack:///src/app/features/home/camera/camera.page.ts","webpack:///src/app/shared/camera/camera.service.ts","webpack:///src/app/shared/dialogs/dialogs.service.ts","webpack:///src/app/features/home/camera/camera.module.ts","webpack:///src/app/features/home/camera/camera-routing.module.ts"],"names":["CameraPage","dialogsService","momentRepository","cameraService","videoDevices$","_videoElement$","undefined","videoElement$","pipe","capturedImageUrl$","startPreview","value","next","nativeElement","videoElement","connectPreview$","err","presentError","subscribe","capture$","imageBlob","add$","nextCamera$","CameraService","videoStreamSelector","VideoStreamSelector","devices$","mediaStream$","stream$","imageCapture$","mediaStream","getVideoTracks","track","ImageCapture","bufferSize","refCount","_capturedImageUrl$","revokePreviousImageUrl","srcObject","imageCapture","takePhoto","URL","createObjectURL","DOMException","name","devices","length","next$","navigator","mediaDevices","enumerateDevices","filter","d","kind","currentVideoDeviceIndex","_stream$","getCurrentVideoMedia","stopMediaStream","forEach","t","stop","getUserMedia","video","deviceId","source$","previous","revokeObjectURL","DialogsService","alertController","error","console","create","header","Error","message","JSON","stringify","buttons","text","alert","present","CameraPageModule","routes","path","component","CameraPageRoutingModule","forChild"],"mappings":"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","file":"4-es5.689d467a4d3487e8dba3.js","sourcesContent":["<ion-button routerLink=\"..\" routerDirection=\"back\" class=\"dismiss\" fill=\"clear\">\n  <ion-icon slot=\"icon-only\" name=\"close-outline\" color=\"light\"></ion-icon>\n</ion-button>\n<ng-container *ngIf=\"(videoDevices$ | ngrxPush)?.length !== 0; else noCamera\">\n  <ion-button (click)=\"capture()\" class=\"capture\" fill=\"clear\">\n    <ion-icon\n      slot=\"icon-only\"\n      name=\"radio-button-on-outline\"\n      color=\"light\"\n    ></ion-icon>\n  </ion-button>\n  <ion-button\n    *ngIf=\"(videoDevices$ | ngrxPush)?.length > 1\"\n    (click)=\"reverseCamera()\"\n    class=\"capture\"\n    class=\"reverse-camera\"\n    fill=\"clear\"\n  >\n    <ion-icon\n      slot=\"icon-only\"\n      name=\"camera-reverse-outline\"\n      color=\"light\"\n    ></ion-icon>\n  </ion-button>\n  <div\n    *ngrxLet=\"capturedImageUrl$ as capturedImageUrl\"\n    class=\"captured ion-margin\"\n  >\n    <app-image [src]=\"capturedImageUrl\"></app-image>\n  </div>\n  <video #video playsinline autoplay></video>\n</ng-container>\n<ng-template #noCamera>\n  <div class=\"no-camera\">\n    <div *transloco=\"let t\" class=\"no-camera-illustration\">\n      <ion-img src=\"./assets/icons/undraw-void.svg\"></ion-img>\n      <h3>{{ t('noCameraFound') }}</h3>\n      <p>{{ t('message.noCameraFound') }}</p>\n    </div>\n  </div>\n</ng-template>\n","import { Component, ElementRef, ViewChild } from '@angular/core';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { BehaviorSubject } from 'rxjs';\nimport { catchError, concatMap, distinctUntilChanged } from 'rxjs/operators';\nimport { CameraService } from '../../../shared/camera/camera.service';\nimport { DialogsService } from '../../../shared/dialogs/dialogs.service';\nimport { MomentRepository } from '../../../shared/moment/moment-repository.service';\nimport { concatTap, isNonNullable } from '../../../utils/rx-operators';\n\n@UntilDestroy()\n@Component({\n  selector: 'app-camera',\n  templateUrl: './camera.page.html',\n  styleUrls: ['./camera.page.scss'],\n})\nexport class CameraPage {\n  readonly videoDevices$ = this.cameraService.videoDevices$;\n\n  private readonly _videoElement$ = new BehaviorSubject<\n    HTMLVideoElement | undefined\n  >(undefined);\n\n  private readonly videoElement$ = this._videoElement$.pipe(\n    isNonNullable(),\n    distinctUntilChanged()\n  );\n\n  @ViewChild('video')\n  set videoElement(value: ElementRef<HTMLVideoElement> | undefined) {\n    if (value) this._videoElement$.next(value.nativeElement);\n  }\n\n  readonly capturedImageUrl$ = this.cameraService.capturedImageUrl$;\n\n  constructor(\n    private readonly dialogsService: DialogsService,\n    private readonly momentRepository: MomentRepository,\n    private readonly cameraService: CameraService\n  ) {\n    this.startPreview();\n  }\n\n  private startPreview() {\n    return this.videoElement$\n      .pipe(\n        concatMap(videoElement =>\n          this.cameraService.connectPreview$(videoElement)\n        ),\n        catchError(async (err: unknown) =>\n          this.dialogsService.presentError(err)\n        ),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n\n  capture() {\n    this.cameraService\n      .capture$()\n      .pipe(\n        concatTap(imageBlob => this.momentRepository.add$(imageBlob)),\n        catchError(async (err: unknown) =>\n          this.dialogsService.presentError(err)\n        ),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n\n  reverseCamera() {\n    return this.videoElement$\n      .pipe(\n        concatMap(videoElement => this.cameraService.nextCamera$(videoElement)),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n}\n","import { Injectable } from '@angular/core';\nimport { BehaviorSubject, defer, iif, Observable, ReplaySubject } from 'rxjs';\nimport {\n  catchError,\n  concatMap,\n  concatMapTo,\n  distinctUntilChanged,\n  first,\n  map,\n  mapTo,\n  pairwise,\n  shareReplay,\n  startWith,\n  switchMap,\n  tap,\n} from 'rxjs/operators';\nimport { finalizeLast, isNonNullable } from '../../utils/rx-operators';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class CameraService {\n  private readonly videoStreamSelector = new VideoStreamSelector();\n\n  readonly videoDevices$ = this.videoStreamSelector.devices$;\n\n  private readonly mediaStream$ = this.videoStreamSelector.stream$;\n\n  private readonly imageCapture$ = this.mediaStream$.pipe(\n    map(mediaStream => mediaStream.getVideoTracks()[0]),\n    isNonNullable(),\n    map(track => new ImageCapture(track)),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly _capturedImageUrl$ = new BehaviorSubject<string | undefined>(\n    undefined\n  );\n\n  readonly capturedImageUrl$ = this._capturedImageUrl$.pipe(\n    isNonNullable(),\n    distinctUntilChanged(),\n    revokePreviousImageUrl()\n  );\n\n  connectPreview$(videoElement: HTMLVideoElement) {\n    return this.mediaStream$.pipe(\n      tap(mediaStream => (videoElement.srcObject = mediaStream)),\n      mapTo(videoElement)\n    );\n  }\n\n  capture$() {\n    return this.imageCapture$.pipe(\n      first(),\n      switchMap(imageCapture => imageCapture.takePhoto()),\n      tap(imageBlob => {\n        this._capturedImageUrl$.next(URL.createObjectURL(imageBlob));\n      }),\n      catchError(async (err: unknown) => {\n        if (\n          err instanceof DOMException &&\n          (err.name === 'InvalidStateError' ||\n            err.name === 'UnknownError' ||\n            err.name === 'OperationError')\n        ) {\n          return undefined;\n        }\n        throw err;\n      }),\n      isNonNullable()\n    );\n  }\n\n  nextCamera$(videoElement: HTMLVideoElement) {\n    return this.videoDevices$.pipe(\n      first(),\n      concatMap(devices =>\n        iif(\n          () => devices.length > 1,\n          defer(async () => (videoElement.srcObject = null)).pipe(\n            concatMapTo(this.videoStreamSelector.next$())\n          )\n        )\n      )\n    );\n  }\n}\n\nclass VideoStreamSelector {\n  readonly devices$ = defer(() =>\n    navigator.mediaDevices.enumerateDevices()\n  ).pipe(\n    map(devices => devices.filter(d => d.kind === 'videoinput')),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private currentVideoDeviceIndex = 0;\n\n  private readonly _stream$ = new ReplaySubject<MediaStream>(1);\n\n  readonly stream$ = this.devices$.pipe(\n    first(),\n    concatMap(devices => this.getCurrentVideoMedia(devices)),\n    tap(mediaStream => this._stream$.next(mediaStream)),\n    concatMapTo(this._stream$),\n    shareReplay({ bufferSize: 1, refCount: true }),\n    isNonNullable(),\n    finalizeLast(mediaStream => stopMediaStream(mediaStream)),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  next$() {\n    return this.stream$.pipe(\n      first(),\n      tap(mediaStream => mediaStream.getVideoTracks().forEach(t => t.stop())),\n      concatMapTo(this.devices$),\n      tap(() => this.currentVideoDeviceIndex++),\n      concatMap(devices => this.getCurrentVideoMedia(devices)),\n      tap(mediaStream => this._stream$.next(mediaStream))\n    );\n  }\n\n  private async getCurrentVideoMedia(devices: MediaDeviceInfo[]) {\n    return navigator.mediaDevices.getUserMedia({\n      video: {\n        deviceId:\n          devices[this.currentVideoDeviceIndex % devices.length].deviceId,\n      },\n    });\n  }\n}\n\nfunction revokePreviousImageUrl() {\n  return (source$: Observable<string>) =>\n    source$.pipe(\n      startWith(undefined),\n      pairwise(),\n      tap(([previous]) => {\n        if (previous) URL.revokeObjectURL(previous);\n      }),\n      concatMapTo(source$)\n    );\n}\n\nfunction stopMediaStream(mediaStream: MediaStream) {\n  mediaStream.getVideoTracks().forEach(t => t.stop());\n  return mediaStream;\n}\n","import { Injectable } from '@angular/core';\nimport { AlertController } from '@ionic/angular';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class DialogsService {\n  constructor(private readonly alertController: AlertController) {}\n\n  async presentError(error: unknown) {\n    // eslint-disable-next-line no-console\n    console.error(error);\n    const alert = await this.alertController.create({\n      header: error instanceof Error ? error.name : 'Unknown Error',\n      message: error instanceof Error ? error.message : JSON.stringify(error),\n      buttons: [{ text: 'ok' }],\n    });\n    await alert.present();\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { NgxIonicImageViewerModule } from 'ngx-ionic-image-viewer';\nimport { SharedModule } from '../../../shared/shared.module';\nimport { CameraPageRoutingModule } from './camera-routing.module';\nimport { CameraPage } from './camera.page';\n\n@NgModule({\n  imports: [SharedModule, CameraPageRoutingModule, NgxIonicImageViewerModule],\n  declarations: [CameraPage],\n})\nexport class CameraPageModule {}\n","import { NgModule } from '@angular/core';\nimport { RouterModule, Routes } from '@angular/router';\nimport { CameraPage } from './camera.page';\n\nconst routes: Routes = [\n  {\n    path: '',\n    component: CameraPage,\n  },\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule],\n})\nexport class CameraPageRoutingModule {}\n"]}