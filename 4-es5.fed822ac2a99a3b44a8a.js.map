{"version":3,"sources":["webpack:///src/app/features/home/camera/camera.page.html","webpack:///src/app/features/home/camera/camera.page.ts","webpack:///src/app/shared/camera/camera.service.ts","webpack:///src/app/shared/dialogs/dialogs.service.ts","webpack:///src/app/features/home/camera/camera.module.ts","webpack:///src/app/features/home/camera/camera-routing.module.ts"],"names":["CameraPage","dialogsService","momentRepository","cameraService","_videoElement$","undefined","videoElement$","pipe","capturedImageUrl$","startPreview","value","next","nativeElement","videoElement","connectPreview$","err","presentError","subscribe","capture$","imageBlob","add$","capture","CameraService","mediaStream$","navigator","mediaDevices","getUserMedia","video","facingMode","mediaStream","getTracks","forEach","track","stop","bufferSize","refCount","imageCapture$","getVideoTracks","ImageCapture","_capturedImageUrl$","revokePreviousImageUrl","srcObject","imageCapture","takePhoto","URL","createObjectURL","DOMException","name","source$","previous","revokeObjectURL","DialogsService","alertController","error","console","create","header","Error","message","JSON","stringify","buttons","text","alert","present","CameraPageModule","routes","path","component","CameraPageRoutingModule","forChild"],"mappings":"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","file":"4-es5.fed822ac2a99a3b44a8a.js","sourcesContent":["<ion-button routerLink=\"..\" routerDirection=\"back\" class=\"dismiss\" fill=\"clear\">\n  <ion-icon slot=\"icon-only\" name=\"close-outline\" color=\"light\"></ion-icon>\n</ion-button>\n<ion-button (click)=\"capture()\" class=\"capture\" fill=\"clear\">\n  <ion-icon\n    slot=\"icon-only\"\n    name=\"radio-button-on-outline\"\n    color=\"light\"\n  ></ion-icon>\n</ion-button>\n<div\n  *ngrxLet=\"capturedImageUrl$ as capturedImageUrl\"\n  class=\"captured ion-margin\"\n>\n  <app-image ionImgViewer [src]=\"capturedImageUrl\"></app-image>\n</div>\n<video #video playsinline autoplay></video>\n","import { Component, ElementRef, ViewChild } from '@angular/core';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { BehaviorSubject } from 'rxjs';\nimport { catchError, concatMap, distinctUntilChanged } from 'rxjs/operators';\nimport { CameraService } from '../../../shared/camera/camera.service';\nimport { DialogsService } from '../../../shared/dialogs/dialogs.service';\nimport { MomentRepository } from '../../../shared/moment/moment-repository.service';\nimport { concatTap, isNonNullable } from '../../../utils/rx-operators';\n\n@UntilDestroy()\n@Component({\n  selector: 'app-camera',\n  templateUrl: './camera.page.html',\n  styleUrls: ['./camera.page.scss'],\n})\nexport class CameraPage {\n  private readonly _videoElement$ = new BehaviorSubject<\n    HTMLVideoElement | undefined\n  >(undefined);\n\n  private readonly videoElement$ = this._videoElement$.pipe(\n    isNonNullable(),\n    distinctUntilChanged()\n  );\n\n  @ViewChild('video')\n  set videoElement(value: ElementRef<HTMLVideoElement>) {\n    this._videoElement$.next(value.nativeElement);\n  }\n\n  readonly capturedImageUrl$ = this.cameraService.capturedImageUrl$;\n\n  constructor(\n    private readonly dialogsService: DialogsService,\n    private readonly momentRepository: MomentRepository,\n    private readonly cameraService: CameraService\n  ) {\n    this.startPreview();\n  }\n\n  private startPreview() {\n    return this.videoElement$\n      .pipe(\n        concatMap(videoElement =>\n          this.cameraService.connectPreview$(videoElement)\n        ),\n        catchError(async (err: unknown) =>\n          this.dialogsService.presentError(err)\n        ),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n\n  capture() {\n    this.cameraService\n      .capture$()\n      .pipe(\n        concatTap(imageBlob => this.momentRepository.add$(imageBlob)),\n        catchError(async (err: unknown) =>\n          this.dialogsService.presentError(err)\n        ),\n        untilDestroyed(this)\n      )\n      .subscribe();\n  }\n}\n","import { Injectable } from '@angular/core';\nimport { BehaviorSubject, defer, Observable } from 'rxjs';\nimport {\n  catchError,\n  concatMapTo,\n  distinctUntilChanged,\n  first,\n  map,\n  mapTo,\n  pairwise,\n  shareReplay,\n  switchMap,\n  tap,\n} from 'rxjs/operators';\nimport {\n  finalizeLast,\n  ignoreComplete,\n  isNonNullable,\n} from '../../utils/rx-operators';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class CameraService {\n  private readonly mediaStream$ = defer(() =>\n    navigator.mediaDevices.getUserMedia({\n      video: { facingMode: 'environment' },\n    })\n  ).pipe(\n    ignoreComplete(),\n    finalizeLast(mediaStream => {\n      mediaStream.getTracks().forEach(track => track.stop());\n    }),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly imageCapture$ = this.mediaStream$.pipe(\n    isNonNullable(),\n    map(mediaStream => mediaStream.getVideoTracks()[0]),\n    isNonNullable(),\n    map(track => new ImageCapture(track)),\n    shareReplay({ bufferSize: 1, refCount: true })\n  );\n\n  private readonly _capturedImageUrl$ = new BehaviorSubject<string | undefined>(\n    undefined\n  );\n\n  readonly capturedImageUrl$ = this._capturedImageUrl$.pipe(\n    isNonNullable(),\n    distinctUntilChanged(),\n    revokePreviousImageUrl()\n  );\n\n  connectPreview$(videoElement: HTMLVideoElement) {\n    return this.mediaStream$.pipe(\n      isNonNullable(),\n      tap(mediaStream => (videoElement.srcObject = mediaStream)),\n      mapTo(videoElement)\n    );\n  }\n\n  capture$() {\n    return this.imageCapture$.pipe(\n      first(),\n      switchMap(imageCapture => imageCapture.takePhoto()),\n      tap(imageBlob => {\n        this._capturedImageUrl$.next(URL.createObjectURL(imageBlob));\n      }),\n      catchError(async (err: unknown) => {\n        if (\n          err instanceof DOMException &&\n          (err.name === 'InvalidStateError' ||\n            err.name === 'UnknownError' ||\n            err.name === 'OperationError')\n        ) {\n          return undefined;\n        }\n        throw err;\n      }),\n      isNonNullable()\n    );\n  }\n}\n\nfunction revokePreviousImageUrl() {\n  return (source$: Observable<string>) =>\n    source$.pipe(\n      pairwise(),\n      tap(([previous]) => URL.revokeObjectURL(previous)),\n      concatMapTo(source$)\n    );\n}\n","import { Injectable } from '@angular/core';\nimport { AlertController } from '@ionic/angular';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class DialogsService {\n  constructor(private readonly alertController: AlertController) {}\n\n  async presentError(error: unknown) {\n    // eslint-disable-next-line no-console\n    console.error(error);\n    const alert = await this.alertController.create({\n      header: error instanceof Error ? error.name : 'Unknown Error',\n      message: error instanceof Error ? error.message : JSON.stringify(error),\n      buttons: [{ text: 'ok' }],\n    });\n    await alert.present();\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { NgxIonicImageViewerModule } from 'ngx-ionic-image-viewer';\nimport { SharedModule } from '../../../shared/shared.module';\nimport { CameraPageRoutingModule } from './camera-routing.module';\nimport { CameraPage } from './camera.page';\n\n@NgModule({\n  imports: [SharedModule, CameraPageRoutingModule, NgxIonicImageViewerModule],\n  declarations: [CameraPage],\n})\nexport class CameraPageModule {}\n","import { NgModule } from '@angular/core';\nimport { RouterModule, Routes } from '@angular/router';\nimport { CameraPage } from './camera.page';\n\nconst routes: Routes = [\n  {\n    path: '',\n    component: CameraPage,\n  },\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule],\n})\nexport class CameraPageRoutingModule {}\n"]}